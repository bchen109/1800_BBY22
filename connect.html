<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>My BCIT Project</title>
    <meta name="comp1800 boilerplate code" content="my bcit project">
    <meta name="author" content="BCIT">

    <!-- Bootstrap, firebase-auth-ui -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <!-- Optional styles and scripts of your own -->
    <link rel="stylesheet" href="styles/connect.css">
</head>

<body>

    <!-------------------------------------->
    <!-- The following is HTML for layout -->
    <!-------------------------------------->
    <!-- Header Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-info">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Student Connect</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="profile.html">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container-fluid justify-content-evenly">
            <a href="home.html" class="home" style="color: black;">
                <span class="material-icons" style="font-size: 45px;">
                    home
                </span>
            </a>
            <a href="connect.html" class="home">
                <span class="material-icons" style="font-size: 45px;">
                    people
                </span>
            </a>
            <a href="notifications.html" class="home" style="color: black;">
                <span class="material-icons" style="font-size: 45px;">
                    notifications
                </span>
            </a>
        </div>
    </nav>
    <!-- welcome and main part of the page -->

    <h1>Connect</h1>

    <h3 id="quote">Choose who to connect to from a personalized list of volunteers.</h3>


    <div class="connect">
        <div id="img-container">
            <a id="profilelink" href=".">
                <img alt="" id="volunteer-img" src="images/random_guy.jpg">
            </a>
        </div>
        <div class="volunteer-info">
            <h4 id="fullname">Name</h4>
            <h4 id="occupation">Program / College</h4>
            <h4 id="nationality-languages">Nationality / Languages</h4>
        </div>
    </div>

    <section id="buttons">
        <button type="button" id="connect-button" class="btn btn-success btn-lg">Connect!</button>
        <button id="next-button" type="button" class="btn btn-primary btn-lg">Next</button>
    </section>

    <h2>Your connections</h2>
    <div id="connection-container" class="container">
        <!-- <div class="card mb-2">
            <div class="container d-flex card-spacing">
                <div class="vertical-align">
                    <img src="./images/random_guy.jpg" style="width: 100px; height: 100px;" class="card-img-top"
                        alt="...">
                </div>
                <div class="card-body text-start">
                    <h5 style="margin-bottom: 0;">Random Guy</h5>
                    <div>Canadian/ English, French</div>
                    <div>I love to play baseball.</div>
                    <p class="card-text">Studying Computer Science</p>
                </div>
            </div>
        </div> -->
    </div>
    <!-- Flexbox container for aligning the toasts -->
    <div style="width: auto; height: 1px; overflow: hidden;">
        <div aria-live="polite" aria-atomic="true" class="d-flex justify-content-center align-items-center"
            style="min-height: 200px;">
            <!-- Then put toasts within -->
            <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <img id="toast-logo" src="./images/logo.jpg" class="rounded me-2" alt="...">
                    <strong class="me-auto">Student Connect</strong>
                    <small>Now</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div id="toast-notification" class="toast-body">
                    Notification shown here
                </div>
            </div>
        </div>
    </div>
    <!----------------------------------------------->
    <!-- JS: Boostrap, Firebase, API related, add Jquery    -->
    <!----------------------------------------------->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
        </script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <!-- Link to the api keys for your firebase project -->
    <script src="scripts/firebaseAPI.js"></script>

    <!--------------------------------------------------------------------->
    <!-- JS files: Your own JavaScript functions included here    -->
    <!--------------------------------------------------------------------->
    <script>
        /**
         * This function redirects the user to the login page if they are not signed in
         * 
         */
        function redirectIfNotLoggedIn() {
            firebase.auth().onAuthStateChanged(user => {
                // Check if the user is signed in:
                if (!user) {
                    console.log("User not logged in");
                    window.location.replace("login.html");
                }
            });
        }
        redirectIfNotLoggedIn();
        
        /**
         * This function creates a boot strap card and adds it to the DOM to show a list of connections that this user is currently connected to
         */
        function connectionCard(userName, userNationality, userLanguage, userStudy, userHobby, imageLink,
        connectionId) {
            // Create the Card container
            let cardContainer = document.createElement("div");
            cardContainer.classList = "card mb-2";

            // Create flex box
            let flexContainer = document.createElement("div");
            flexContainer.classList = "d-flex container card-spacing";

            // Create image container
            let imageDiv = document.createElement("div");
            imageDiv.classList = "vertical-align";


            // Create image object
            let image = document.createElement("img");
            image.setAttribute("src", String(imageLink));
            image.setAttribute("alt", "profile");
            image.classList = "volunteer-image card-img-top";

            // Create link to wrap around image
            let connectionLink = document.createElement("a");
            connectionLink.setAttribute("href", "viewprofile.html?userid=" + connectionId);

            // Create card body
            let cardBody = document.createElement("div");
            cardBody.classList = "card-body text-start";

            // Create card title
            let cardTitle = document.createElement("h5");
            cardTitle.innerText = userName;

            // Create card natinality/ language
            let cardNationality = document.createElement("div");
            cardNationality.innerText = userNationality + "/ " + userLanguage

            // Create card hobby
            let cardHobby = document.createElement("div");
            cardHobby.innerText = userHobby;

            // Create card fieldofstudy
            let cardStudy = document.createElement("p");
            cardStudy.classList = "card-text";
            cardStudy.innerText = userStudy;

            cardContainer.appendChild(flexContainer);
            flexContainer.appendChild(imageDiv);
            connectionLink.appendChild(image);
            imageDiv.appendChild(connectionLink);
            flexContainer.append(cardBody);
            cardBody.appendChild(cardTitle);
            cardBody.appendChild(cardNationality);
            cardBody.appendChild(cardHobby);
            cardBody.appendChild(cardStudy);

            document.getElementById("connection-container").appendChild(cardContainer);
        }

        /**
         * This function deletes all the randomly generated volunteer accounts in the database.
         * SHOULD ONLY BE RUN THROUGH CONSOLE!!!
         */
        function deleteVolunteers() {
            var volunteers = db.collection('userdata');
            volunteers.get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    if (String(doc.id).includes("volunteer")) {
                        db.collection("userdata").doc(doc.id).delete().then(function () {
                            console.log("Document deleted!");
                        }).catch((error) => {
                            console.error("Error", error);
                        });
                    }
                })
            })
        }

        /**
         * This function retreives a list of volunteers based on the current useres field of study and saves them
         * inside an array
         */
        async function getVolunteers() {
            let userId = localStorage.getItem("userId");
            let userDoc = db.collection('userdata').doc(userId);
            let doc = await userDoc.get();
            let volunteerId;
            var result = [];
            if (!doc.exists) {
                console.log('No such user document!');
            } else {
                let data = doc.data();
                let userConnections = data.connections;
                let volunteerData;
                let volunteerId;
                await db.collection('userdata').where("volunteer", "==", true).where("fieldofstudy",
                    "==", data.fieldofstudy).get().then(function (queryVolunteers) {
                        queryVolunteers.forEach((doc) => {
                            if (doc.id != userId && !userConnections.includes(doc.id)) {
                                result.push(doc.data());
                                volunteerIds.push(doc.id);
                            }
                        })
                    });
                return result;
            }
        }

        /**
         * This function loads the basic volunteer profile onto the page.
         * 
         * Precondition: getVolunteers() must be called before calling this function
         */
        function onLoad() {
            currentIndex = currentIndex % maxIndex;
            let volunteerData = volunteers[currentIndex];
            let volunteerId = volunteerIds[currentIndex];
            document.getElementById("fullname").innerText = volunteerData.fullname;
            document.getElementById("occupation").innerText = volunteerData.occupation;
            document.getElementById("nationality-languages").innerText = volunteerData.nationality + "/ " +
                volunteerData.languages;
            document.getElementById("quote").innerText = volunteerData.quote;
            document.getElementById("profilelink").setAttribute("href", "viewprofile.html?userid=" + volunteerId);

            console.log(volunteerId + "/profile.jpg");

            firebase.app().storage().ref("users").child(volunteerId + "/profile.jpg").getDownloadURL().then(imgUrl => {
                console.log(imgUrl);
                document.getElementById("volunteer-img").src = imgUrl;
            });
            currentIndex++;
        }

        /**
         * This function retrieves the current date.
         */
        function getDate() {
            let today = new Date();
            let date = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
            let time = today.getHours() + ":" + today.getMinutes();
            let dateTime = date + ' ' + time;
            return dateTime;
        }

        /**
         * This function handles what happens when the user wants to connect with a voluntter.
         */
        async function sendConnectRequest() {
            let currentVolunteerId = volunteerIds[currentIndex - 1];
            let userId = localStorage.getItem("userId");
            let duplicate = false;

            // Checking if the a pending connection already exists or if the connection has already been made
            let userDoc = await db.collection("userdata").doc(userId).get();
            let notificationMessage;
            userDoc = userDoc.data();
            userDoc.pending.forEach((item) => {
                if (String(item) == String(currentVolunteerId)) {
                    duplicate = true;
                    notificationMessage = "There is already a pending connection.";
                }
            })
            userDoc.connections.forEach((item) => {
                if (String(item) == String(currentVolunteerId)) {
                    duplicate = true;
                    notificationMessage = "You are already connected with this user.";
                }
            })
            if (!duplicate) {
                db.collection("notifications").add({
                    date: String(getDate()),
                    description: String("New connection request from " + userDoc.fullname),
                    type: String("connection"),
                    title: String("Connection Request!"),
                    touser: String(currentVolunteerId),
                    fromuser: String(userId)
                }).then((docRef) => {
                    db.collection("userdata").doc(currentVolunteerId).update({
                        notifications: firebase.firestore.FieldValue.arrayUnion(String(docRef.id))
                    }).then(function () {
                        console.log("Notification sent successfully to -> " + currentVolunteerId);
                    });
                    db.collection("userdata").doc(userId).update({
                        pending: firebase.firestore.FieldValue.arrayUnion(String(
                            currentVolunteerId))
                    }).then(function () {
                        console.log("Pending connections added " + currentVolunteerId);
                    });
                });
                document.getElementById("toast-notification").innerText = "Connection sent!";
                $('.toast').toast('show');
            } else {
                document.getElementById("toast-notification").innerText = notificationMessage;
                $('.toast').toast('show');
                console.log("Duplicate connection request");
            }
        }

        /**
         * This function is in charge of retreiving a list of connections with the current user and displaying it onto
         * the screen.
         */
        async function loadConnections() {
            let userId = localStorage.getItem("userId");
            let userDoc = await db.collection("userdata").doc(userId).get();
            userDoc = userDoc.data();
            userDoc.connections.forEach((item) => {
                console.log("Connection User ID: " + item);
                db.collection("userdata").doc(item).get().then((doc) => {
                    let connectionData = doc.data();
                    let userName = connectionData.fullname;
                    let userStudy = connectionData.fieldofstudy;
                    let userLanguage = connectionData.languages;
                    let userNationality = connectionData.nationality;
                    let userHobby = connectionData.hobbies;
                    let connectionId = doc.id;
                    let imageLink;
                    firebase.app().storage().ref("users").child(doc.id + "/profile.jpg")
                        .getDownloadURL().then(imgUrl => {
                            console.log("Retrieved image" + imgUrl);
                            imageLink = imgUrl;
                            connectionCard(userName, userNationality, userLanguage, userStudy,
                                userHobby, imageLink, connectionId);
                        });
                })
            });
        }

        // Current index for the list of volunteers
        var currentIndex;

        // The maximum size of array
        var maxIndex;

        // List of volunteers and their data
        var volunteers;

        // List of volunteer ids
        var volunteerIds = [];

        /**
         * Main function which drives the program and stiches all the fuctions together
         */
        async function main() {
            volunteers = await getVolunteers();
            loadConnections();
            currentIndex = 0;
            maxIndex = volunteers.length - 1;
            console.log(volunteers);
            onLoad();
            document.getElementById("next-button").addEventListener('click', onLoad, false);
            document.getElementById("connect-button").addEventListener('click', sendConnectRequest, false);
        }
        main();
    </script>

</body>

</html>