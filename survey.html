<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Student Connect</title>
    <meta name="comp1800 boilerplate code" content="Studnet Connect Application">
    <meta name="BBY22" content="Student Connect">

    <!-- Bootstrap -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />

    <!-- FirebaseUI CSS -->
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.css" />

    <!-- Optional styles and scripts of your own -->
    <link type="text/css" rel="stylesheet" href="styles/survey.css">
</head>

<body>

    <!-------------------------------------->
    <!-- The following is HTML for layout -->
    <!-------------------------------------->
    <!-- Header Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-info">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Student Connect</a>
        </div>
    </nav>
    <!-- welcome and main part of the page -->
    <div class="container justify-content-start" id="container">
        <div id="header" class="p-2">
            <h1>Create Account</h1>
        </div>
        <form class="needs-validation">
            <div class="mb-0 p-2">
                <label for="exampleFormControlInput1" class="form-label">Enter your age:</label>
                <input type="number" class="form-control" id="age" placeholder="21" required>
            </div>
            <div class="mb-0 p-2">
                <input class="form-check-input" type="checkbox" value="" id="volunteer">
                <label class="form-check-label" for="defaultCheck1">Signup as volunteer?</label>
            </div>
            <div class="mb-0 p-2">
                <label for="exampleFormControlInput1" class="form-label">Languages:</label>
                <input type="text" class="form-control" id="languages" placeholder="English, French" required>
            </div>

            <div class="mb-0 p-2">
                <label for="exampleFormControlInput1" class="form-label">Nationality:</label>
                <input type="text" class="form-control" id="nationality" placeholder="Canadian, Japanese" required>
            </div>

            <div class="mb-0 p-2">
                <label for="exampleFormControlInput1" class="form-label">Occupation:</label>
                <input type="text" class="form-control" id="occupation" placeholder="Software Engineer" required>
            </div>

            <div class="mb-0 p-2">
                <label for="exampleFormControlInput1" class="form-label">Hobbies:</label>
                <input type="text" class="form-control" id="hobbies" placeholder="Badminton, Tennis, Baseball" required>
            </div>

            <div class="mb-0 p-2">
                <label for="exampleFormControlInput1" class="form-label">Area of Study:</label>
                <select id="fieldofstudy" class="form-select" aria-label="Default select example" required>
                    <option selected value="">Click here to select an option</option>
                    <option value="1">Applied &amp; Natural Sciences</option>
                    <option value="2">Business &amp; Media</option>
                    <option value="3">Computing &amp; Information Technology</option>
                    <option value="4">Engineering</option>
                    <option value="5">Health Sciences</option>
                    <option value="6">Trades</option>
                </select>
            </div>

            <div class="mb-0 p-2">
                <label for="exampleFormControlInput1" class="form-label">Profile Picture</label>
                <input id="fileUpload" type="file" onchange="loadImageFile();" class="form-control" aria-label="file example">
            </div>

            <div class="mb-0 p-2">
                <label for="exampleFormControlInput1" class="form-label">Your quote:</label>
                <input type="text" class="form-control" id="quote"
                    placeholder="Hi, my name is bob and I love reading mystery novels!">
            </div>

            <div class="mb-0 p-2">
                <button type="submit" id="submit-button" class="btn btn-primary">Sign Up</button>
            </div>
            <br><br>
        </form>
    </div>
    <!----------------------------------------------->
    <!-- JS: Boostrap, Firebase, API related, add Jquery    -->
    <!----------------------------------------------->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>


    <!-- Link to the api keys for your firebase project -->
    <script src="scripts/firebaseAPI.js"></script>

    <!--------------------------------------------------------------------->
    <!-- JS files: Your own JavaScript functions included here    -->
    <!--------------------------------------------------------------------->
    <script>
        var userId = localStorage.getItem("userId");
        console.log("Current User: " + userId);

        /**
         * Checks if the form is valid before allows submission and changes to firestore.
         */
        function checkValidityForm() {
            const forms = document.querySelectorAll('.needs-validation');
            // Loop over them and prevent submission
            Array.prototype.slice.call(forms).forEach((form) => {
                form.addEventListener('submit', (event) => {
                    if (!form.checkValidity()) {
                        console.log("Invalid!");
                        event.preventDefault();
                        event.stopPropagation();
                    } else {
                        updateUser();
                        event.preventDefault();
                        event.stopPropagation();
                    }
                }, false);
            });
        }

        /**
         * Updates the user information to firebase.
         */
        function updateUser() {
            if (userId) {
                db.collection("userdata").doc(userId)
                    .update({ //write to firestore. We are using the UID for the ID in users collection
                        // fullname: "hello world", //"users" collection
                        // email: "hello world" //with authenticated user's ID (user.uid)
                        age: Number(document.getElementById("age").value),
                        hobbies: String(document.getElementById("hobbies").value),
                        languages: String(document.getElementById("languages").value),
                        nationality: String(document.getElementById("nationality").value),
                        profilepicture: String("/uesrs/default/profile.jpg"),
                        volunteer: Boolean(document.getElementById("volunteer").checked),
                        quote: String(document.getElementById("quote").value),
                        occupation: String(document.getElementById("occupation").value),
                        fieldofstudy: String(getFieldOfStudy(document.getElementById("fieldofstudy").value)),
                        connections: [],
                        pending: [],
                        notifications: [],
                    }).then(function () {
                        console.log("User data updated");
                        window.location.assign("profile.html"); //re-direct to main.html after signup
                    })
                    .catch(function (error) {
                        window.location.assign("login.html"); //re-direct to main.html after signup
                        console.log("Error updating user data: " + error);
                    });
            } else {
                console.log("Error no user parameter detected");
            }
        }


        /**
         * This function retrieves parameter values from the url.
         */
        function getParameter(name) {
            var url_string = window.location.href;
            var url = new URL(url_string);
            var paramValue = url.searchParams.get(name);
            return paramValue;
        }

        /**
         * This function handles the button click when the user tries to subit the survey form
         */
        function handleButtonClick(e) {
            if (e instanceof MouseEvent) {
                checkValidityForm();
                // updateUser();
            }
        }

        /**
         * Thie function returns the field of study that corresponds with the number given.
         */
        function getFieldOfStudy(number) {
            if (number == 1) {
                return "Applied & Natural Sciences";
            } else if (number == 2) {
                return "Business & Media";
            } else if (number == 3) {
                return "Computing & Information Technology";
            } else if (number == 4) {
                return "Engineering";
            } else if (number == 5) {
                return "Health Sciences";
            } else if (number == 6) {
                return "Trades";
            }
            return "ERROR";
        }

        // Initializes a FileReader object
        var fileReader = new FileReader();
        // File types to accept from the upload button
        var filterType =
            /^(?:image\/bmp|image\/cis\-cod|image\/gif|image\/ief|image\/jpeg|image\/jpeg|image\/jpeg|image\/pipeg|image\/png|image\/svg\+xml|image\/tiff|image\/x\-cmu\-raster|image\/x\-cmx|image\/x\-icon|image\/x\-portable\-anymap|image\/x\-portable\-bitmap|image\/x\-portable\-graymap|image\/x\-portable\-pixmap|image\/x\-rgb|image\/x\-xbitmap|image\/x\-xpixmap|image\/x\-xwindowdump)$/i;

        fileReader.onload = function (event) {
            var image = new Image();

            // Resizes the images the user uploads to 200x200
            image.onload = function () {
                // document.getElementById("original-Img").src = image.src;
                var canvas = document.createElement("canvas");
                var context = canvas.getContext("2d");
                // canvas.width = image.width / 4;
                // canvas.height = image.height / 4;
                canvas.width = 200;
                canvas.height = 200;
                context.drawImage(image,
                    0,
                    0,
                    image.width,
                    image.height,
                    0,
                    0,
                    canvas.width,
                    canvas.height
                );
                let userID = localStorage.getItem('userId');
                // Uploads the user photo into firestore
                canvas.toBlob(function(blob) {
                    firebase.app().storage().ref("users").child(userID + "/profile.jpg").put(blob).then(function () {
                        console.log("File Uploaded!");
                    })
                })

            }
            image.src = event.target.result;
        };

        var loadImageFile = function () {
            var uploadImage = document.getElementById("fileUpload");

            //check and retuns the length of uploded file.
            if (uploadImage.files.length === 0) {
                return;
            }

            //Is Used for validate a valid file.
            var uploadFile = document.getElementById("fileUpload").files[0];
            if (!filterType.test(uploadFile.type)) {
                alert("Please select a valid image.");
                return;
            }
            fileReader.readAsDataURL(uploadFile);
        }
        document.getElementById("submit-button").addEventListener("click", handleButtonClick, false);
        // document.getElementById("fileUpload").addEventListener("change", loadImageFile(), false);
        console.log("Loaded");
    </script>

</body>

</html>