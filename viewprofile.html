<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>

    <!-- Third party CSS source for header-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">

    <link type="text/css" rel="stylesheet" href="styles/viewprofile.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-info">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Student Connect</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="profile.html">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container-fluid justify-content-evenly">
            <a href="home.html" class="home" style="color: black;">
                <span class="material-icons" style="font-size: 45px;">
                    home
                </span>
            </a>
            <a href="connect.html" class="home" style="color: black;">
                <span class="material-icons" style="font-size: 45px;">
                    people
                </span>
            </a>
            <a href="notifications.html" class="home" style="color: black;">
                <span class="material-icons" style="font-size: 45px;">
                    notifications
                </span>
            </a>
        </div>
    </nav>

    <div id="container" class="container text-center">
        <div class="wrapper">
            <div class="top-icons">
                <i class="fas fa-long-arrow-alt-left"></i>
                <i class="fas fa-ellipsis-v"></i>
                <i class="far fa-heart"></i>
            </div>

            <div class="profile">
                <img src="https://images.unsplash.com/photo-1484186139897-d5fc6b908812?ixlib=rb-0.3.5&s=9358d797b2e1370884aa51b0ab94f706&auto=format&fit=crop&w=200&q=80%20500w"
                    class="thumbnail" id="profilePicture">
                <div class="check"><i class="fas fa-check"></i></div>
                <h3 class="name" id="fullname">Beverly Little</h3>
                <p class="title" id="occupation">Javascript Developer</p>
                <p class="description" id="quote">Lorem ipsum dolor sit amet consectetur adipisicing elit. Neque aliquam
                    aliquid
                    porro!</p>
                <button type="button" class="btn" id="connectButton">Connect</button>
            </div>

            <div class="card mb-3">
                <div class="card-header fw-bold">
                    Bio
                </div>
                <div>
                    <p id="bio" class="mb-0 pt-1 pb-1 font-style">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer posuere erat a ante.</p>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header fw-bold">
                    Field Of Study
                </div>
                <div>
                    <p id="fieldofstudy" class="mb-0 pt-1 pb-1 font-style">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer posuere erat a ante.</p>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header fw-bold">
                    Hobbies
                </div>
                <div>
                    <p id="hobbies" class="mb-0 pt-1 pb-1 font-style">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer posuere erat a ante.</p>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header fw-bold">
                    Languages
                </div>
                <div>
                    <p id="languages" class="mb-0 pt-1 pb-1 font-style">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer posuere erat a ante.</p>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header fw-bold">
                    Nationality
                </div>
                <div>
                    <p id="nationality" class="mb-0 pt-1 pb-1 font-style">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer posuere erat a ante.</p>
                </div>
            </div>
            <div class="card" id="contact-card">
                <div class="card-header fw-bold">
                    Contact Information
                </div>
                <div>
                    <p id="contactinfo" class="mb-0 pt-1 pb-1 font-style">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer posuere erat a ante.</p>
                </div>
            </div>
        </div>
    </div>
    <div style="width: auto; height: 1px; overflow: hidden;">
        <div aria-live="polite" aria-atomic="true" class="d-flex justify-content-center align-items-center"
            style="min-height: 200px;">
            <!-- Then put toasts within -->
            <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <img id="toast-logo" src="./images/logo.jpg" class="rounded me-2" alt="...">
                    <strong class="me-auto">Student Connect</strong>
                    <small>Now</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div id="toast-notification" class="toast-body">
                    Notification shown here
                </div>
            </div>
        </div>
    </div>
    <!----------------------------------------------->
    <!-- JS: Boostrap, Firebase, API related, add Jquery-->
    <!----------------------------------------------->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>

    <script src="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <!-- Link to the api keys for your firebase project -->
    <script src="scripts/firebaseAPI.js"></script>

    <script>
        /**
         * This function retrieves the parameters from the url
         */
        function getParameter(name) {
            var url_string = window.location.href;
            var url = new URL(url_string);
            var paramValue = url.searchParams.get(name);
            console.log(paramValue);
            return paramValue;
        }

        /**
         * This function retrieves the user document from firebase and populates it onto the DOM.
         */
        async function getUserDoc(userId) {
            const cityRef = db.collection('userdata').doc(userId);
            const doc = await cityRef.get();
            let currentUser = localStorage.getItem("userId");
            if (!doc.exists) {
                console.log('No such document!');
            } else {
                const data = doc.data();
                if (data.volunteer == true) {
                    document.getElementById("fullname").innerText = data.fullname + " (Volunteer)";
                } else {
                    document.getElementById("fullname").innerText = data.fullname;
                }

                if (data.connections.includes(currentUser)) {
                    document.getElementById("contactinfo").innerText = data.email;
                    document.getElementById("connectButton").remove();
                } else {
                    document.getElementById("connectButton").addEventListener('click', sendConnectRequest, false);
                    document.getElementById("contact-card").remove();
                }

                document.getElementById("quote").innerText = data.quote;
                document.getElementById("bio").innerText = data.bio;
                document.getElementById("occupation").innerText = data.occupation;
                document.getElementById("fieldofstudy").innerText = data.fieldofstudy;
                document.getElementById("nationality").innerText = data.nationality;
                document.getElementById("languages").innerText = data.languages;
                document.getElementById("hobbies").innerText = data.hobbies;
                firebase.app().storage().ref("users").child(userId + "/profile.jpg").getDownloadURL().then(
                    imgUrl => {
                        document.getElementById("profilePicture").src = imgUrl;
                    }).catch(function (error) {
                    console.log("No profile picture found so using default picture");
                });
            }
        }

        /**
         * This function retrieves the current date.
         */
        function getDate() {
            let today = new Date();
            let date = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
            let time = today.getHours() + ":" + today.getMinutes();
            let dateTime = date + ' ' + time;
            return dateTime;
        }

        /**
         * This function handles what happens when the user decides to send a connection request to another user.
         */
        async function sendConnectRequest() {
            let currentVolunteerId = getParameter("userid");
            let userId = localStorage.getItem("userId");
            let duplicate = false;

            // Checking if the a pending connection already exists or if the connection has already been made
            let userDoc = await db.collection("userdata").doc(userId).get();
            let notificationMessage;
            userDoc = userDoc.data();
            userDoc.pending.forEach((item) => {
                if (String(item) == String(currentVolunteerId)) {
                    duplicate = true;
                    notificationMessage = "There is already a pending connection.";
                }
            })
            userDoc.connections.forEach((item) => {
                if (String(item) == String(currentVolunteerId)) {
                    duplicate = true;
                    notificationMessage = "You are already connected with this user.";
                }
            })
            if (!duplicate) {
                db.collection("notifications").add({
                    date: String(getDate()),
                    description: String("New connection request from " + userDoc.fullname),
                    type: String("connection"),
                    title: String("Connection Request!"),
                    touser: String(currentVolunteerId),
                    fromuser: String(userId)
                }).then((docRef) => {
                    db.collection("userdata").doc(currentVolunteerId).update({
                        notifications: firebase.firestore.FieldValue.arrayUnion(String(docRef.id))
                    }).then(function () {
                        console.log("Notification sent successfully to -> " + currentVolunteerId);
                    });
                    db.collection("userdata").doc(userId).update({
                        pending: firebase.firestore.FieldValue.arrayUnion(String(
                            currentVolunteerId))
                    }).then(function () {
                        console.log("Pending connections added " + currentVolunteerId);
                    });
                });
                document.getElementById("toast-notification").innerText = "Connection sent!";
                $('.toast').toast('show');
            } else {
                document.getElementById("toast-notification").innerText = notificationMessage;
                $('.toast').toast('show');
                console.log("Duplicate connection request");
            }
        }

        /**
         * This is the main function for the program and is then entry point.
         */
        async function main() {
            await getUserDoc(getParameter("userid"));
        }
        main();
    </script>
</body>

</html>