<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>

  <!-- Third party CSS source for header-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">

  <link type="text/css" rel="stylesheet" href="styles/profile.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-info">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Student Connect</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="profile.html">Profile</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="settings.html">Settings</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <nav class="navbar navbar-expand-lg navbar-light bg-white">
    <div class="container-fluid justify-content-evenly">
      <a href="home.html" class="home" style="color: black;">
        <span class="material-icons" style="font-size: 45px;">
          home
        </span>
      </a>
      <a href="connect.html" class="home" style="color: black;">
        <span class="material-icons" style="font-size: 45px;">
          people
        </span>
      </a>
      <a href="notifications.html" class="home" style="color: black;">
        <span class="material-icons" style="font-size: 45px;">
          notifications
        </span>
      </a>
    </div>
  </nav>

  <div id="container" class="container">

    <div id="heading" class="text-center">
      <h1>Profile</h1>
    </div>
    <div id="inner">
      <div id="picture" class="text-center">
        <img id="profilePicture" src="images/profile_image_placeholder.jpeg" alt="" />
      </div>
      <div id="fileInput" class="text-center mt-2">
        <!-- <button type="button" class="btn btn-primary btn-lg">Change photo<input type="file" hidden></button> -->
        <!-- <input class="form-control" type="file" id="formFile"> -->
        <label class="btn btn-primary btn-lg">
          Change Photo<input type="file" id="fileUpload" onchange="loadImageFile();" hidden>
        </label>
      </div>
    </div>
    <form class="needs-validation" id="personalInfoFields">
      <div class="p-2 form-group">
        <label>Full Name</label>
        <input type="text" id="nameInput" class="form-control" placeholder="Enter your name">
      </div>
      <div class="p-2 form-group">
        <label>Quote</label>
        <input type="text" id="quoteInput" class="form-control" placeholder="Enter your quote">
      </div>
      <div class="p-2 form-group">
        <label>Occupation</label>
        <input type="text" id="occupationInput" class="form-control" placeholder="Enter your occupation">
      </div>
      <div class="p-2 form-group">
        <label>Bio</label>
        <textarea type="text" id="bioInput" class="form-control" placeholder="Enter your biography" rows="4"></textarea>
      </div>
      <div class="p-2 form-group">
        <label for="exampleFormControlInput1" class="form-label">Area of Study:</label>
        <select id="fieldofstudy" class="form-select" aria-label="Default select example" required>
          <option id="fieldofstudyInput" selected value="">Click here to select an option</option>
          <option value="1">Applied &amp; Natural Sciences</option>
          <option value="2">Business &amp; Media</option>
          <option value="3">Computing &amp; Information Technology</option>
          <option value="4">Engineering</option>
          <option value="5">Health Sciences</option>
          <option value="6">Trades</option>
        </select>
      </div>
      <div class="p-2 form-group">
        <label>Hobbies</label>
        <input type="text" id="hobbiesInput" class="form-control" placeholder="Enter your hobbies">
      </div>
      <div class="p-2 form-group">
        <label>Languages</label>
        <input type="text" id="languagesInput" class="form-control" placeholder="Enter your languages">
      </div>
      <div class="p-2 form-group">
        <label>Nationality</label>
        <input type="text" id="nationalityInput" class="form-control" placeholder="Enter your nationality">
      </div>
      <div class="p-2 form-group">
        <label>Age</label>
        <input type="number" id="ageInput" class="form-control" placeholder="Enter your age">
      </div>
      <div class="submission">
        <div>
          <button type="submit" id="submit" class="btn btn-success btn-lg">Submit</button>
        </div>
        <div>
          <button type="button" id="cancel" class="btn btn-primary btn-lg">Cancel</button>
        </div>
      </div>
    </form>
  </div>

  <br><br>

  <!----------------------------------------------->
  <!-- JS: Boostrap, Firebase, API related, add Jquery-->
  <!----------------------------------------------->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>

  <script src="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <!-- Link to the api keys for your firebase project -->
  <script src="scripts/firebaseAPI.js"></script>

  <script>
    /**
     * If the user is not logged in then redirect them to the login page.
     */
    function redirectIfNotLoggedIn() {
      firebase.auth().onAuthStateChanged(user => {
        // Check if the user is signed in:
        if (!user) {
          console.log("User not logged in");
          window.location.replace("login.html");
        }
      })
    }
    redirectIfNotLoggedIn();

    /**
     * Handles the cancel button on the page.
     */
    function cancelButton() {
      window.location.assign('profile.html');
    }

    /**
     * Updates the user information with the new information the user has entered
     */
    function updateUser() {
      let x = (document.getElementById("nameInput").value == "") ? "default" : "newvalue";
      console.log(x);
      // console.log(document.getElementById("nameInput").value);
      // console.log(document.getElementById("nameInput").value == "");
      // console.log(document.getElementById("nameInput").placeholder);
      let nameInput = (document.getElementById("nameInput").value == "") ? document.getElementById("nameInput")
        .placeholder : document.getElementById("nameInput").value;
      let ageInput = (document.getElementById("ageInput").value == "") ? document.getElementById("ageInput")
        .placeholder : document.getElementById("ageInput").value;
      let hobbiesInput = (document.getElementById("hobbiesInput").value == "") ? document.getElementById("hobbiesInput")
        .placeholder : document.getElementById("hobbiesInput").value;
      let languagesInput = (document.getElementById("languagesInput").value == "") ? document.getElementById(
        "languagesInput").placeholder : document.getElementById("languagesInput").value;
      let occupationInput = (document.getElementById("occupationInput").value == "") ? document.getElementById(
        "occupationInput").placeholder : document.getElementById("occupationInput").value;
      let nationalityInput = (document.getElementById("nationalityInput").value == "") ? document.getElementById(
        "nationalityInput").placeholder : document.getElementById("nationalityInput").value;
      let quoteInput = (document.getElementById("quoteInput").value == "") ? document.getElementById("quoteInput")
        .placeholder : document.getElementById("quoteInput").value;
      let bioInput = (document.getElementById("bioInput").value == "") ? "" : document.getElementById("bioInput").value;
      let fieldofstudyInput = (document.getElementById("fieldofstudyInput").value == "") ? document.getElementById(
        "fieldofstudyInput").innerText : String(getFieldOfStudy(document.getElementById("fieldofstudyInput")).value);
      console.log(nameInput, ageInput, hobbiesInput, languagesInput, occupationInput, nationalityInput, quoteInput,
        bioInput, fieldofstudyInput);
      let userId = localStorage.getItem("userId");
      if (userId) {
        db.collection("userdata").doc(userId)
          .update({ //write to firestore. We are using the UID for the ID in users collection
            fullname: nameInput, //"users" collection
            age: ageInput,
            hobbies: hobbiesInput,
            languages: languagesInput,
            nationality: nationalityInput,
            quote: quoteInput,
            occupation: occupationInput,
            fieldofstudy: fieldofstudyInput,
            bio: bioInput
          }).then(function () {
            console.log("User data updated");
            window.location.assign("profile.html"); //re-direct to main.html after signup
          })
          .catch(function (error) {
            window.location.assign("login.html"); //re-direct to main.html after signup
            console.log("Error updating user data: " + error);
          });
      } else {
        console.log("Error no user parameter detected");
      }
    }

    /**
     * This function inserts data onto the page depending on if a user is logged in
     */
    function insertData() {
      firebase.auth().onAuthStateChanged(user => {
        // Check if user is signed in:
        if (user) {
          // Do something for the current logged-in user here: 
          console.log("Current User: " + user.uid);
          getUserDoc(user.uid);
        } else {
          document.getElementById("name-goes-here").innerText = "Nobody";
        }
      });
    }

    /**
     * This function retrieves the user document from firebase and populates onto the DOM.
     */
    async function getUserDoc(userId) {
      const cityRef = db.collection('userdata').doc(userId);
      const doc = await cityRef.get();
      if (!doc.exists) {
        console.log('No such document!');
      } else {
        const data = doc.data();
        document.getElementById("nameInput").placeholder = data.fullname;
        document.getElementById("quoteInput").placeholder = data.quote;
        document.getElementById("ageInput").placeholder = data.age;
        document.getElementById("bioInput").placeholder = data.bio;
        document.getElementById("occupationInput").placeholder = data.occupation;
        document.getElementById("fieldofstudyInput").innerText = data.fieldofstudy;
        document.getElementById("nationalityInput").placeholder = data.nationality;
        document.getElementById("languagesInput").placeholder = data.languages;
        document.getElementById("hobbiesInput").placeholder = data.hobbies;
        firebase.app().storage().ref("users").child(userId + "/profile.jpg").getDownloadURL().then(imgUrl => {
          document.getElementById("profilePicture").src = imgUrl;
          document.getElementById("personalInfoFields").disabled = false
        });
      }
    }

    // Initializes a file reader object
    var fileReader = new FileReader();
    // File types to accept
    var filterType =
      /^(?:image\/bmp|image\/cis\-cod|image\/gif|image\/ief|image\/jpeg|image\/jpeg|image\/jpeg|image\/pipeg|image\/png|image\/svg\+xml|image\/tiff|image\/x\-cmu\-raster|image\/x\-cmx|image\/x\-icon|image\/x\-portable\-anymap|image\/x\-portable\-bitmap|image\/x\-portable\-graymap|image\/x\-portable\-pixmap|image\/x\-rgb|image\/x\-xbitmap|image\/x\-xpixmap|image\/x\-xwindowdump)$/i;

    // Resizes the image to 200x200 when a user uploads a new photo for their profile picture
    fileReader.onload = function (event) {
      var image = new Image();

      image.onload = function () {
        // document.getElementById("original-Img").src = image.src;
        var canvas = document.createElement("canvas");
        var context = canvas.getContext("2d");
        // canvas.width = image.width / 4;
        // canvas.height = image.height / 4;
        canvas.width = 200;
        canvas.height = 200;
        context.drawImage(image,
          0,
          0,
          image.width,
          image.height,
          0,
          0,
          canvas.width,
          canvas.height
        );
        let userID = localStorage.getItem('userId');
        // Upload the photo to firestore
        canvas.toBlob(function (blob) {
          firebase.app().storage().ref("users").child(userID + "/profile.jpg").put(blob).then(function () {
            console.log("File Uploaded!");
            firebase.app().storage().ref("users").child(userID + "/profile.jpg").getDownloadURL().then(
              imgUrl => {
                document.getElementById("profilePicture").src = imgUrl;
                document.getElementById("personalInfoFields").disabled = false
              }).catch(function (error) {
                console.log("No profile picture found so using default picture");
              });
          })
        })

      }
      image.src = event.target.result;
    };
    var loadImageFile = function () {
      var uploadImage = document.getElementById("fileUpload");

      //check and retuns the length of uploded file.
      if (uploadImage.files.length === 0) {
        return;
      }

      //Is Used for validate a valid file.
      var uploadFile = document.getElementById("fileUpload").files[0];
      if (!filterType.test(uploadFile.type)) {
        alert("Please select a valid image.");
        return;
      }
      fileReader.readAsDataURL(uploadFile);
    }
    insertData();
    document.getElementById("cancel").addEventListener('click', cancelButton, false);
    document.getElementById("submit").addEventListener('click', updateUser, false);
  </script>
</body>

</html>